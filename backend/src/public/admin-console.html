<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gearted Admin Console</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #fff;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { color: #FFB800; font-size: 24px; }
    .header .user-info { color: #888; font-size: 14px; }
    
    /* Login Form */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: #1a1a2e;
      padding: 40px;
      border-radius: 16px;
    }
    .login-container h2 { color: #FFB800; margin-bottom: 20px; text-align: center; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; color: #888; margin-bottom: 6px; font-size: 14px; }
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f0f;
      color: #fff;
      font-size: 16px;
    }
    .form-group input:focus { outline: none; border-color: #FFB800; }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-primary { background: #FFB800; color: #000; }
    .btn-primary:hover { background: #e5a600; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-danger:hover { background: #c82333; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-success:hover { background: #218838; }
    .btn-secondary { background: #333; color: #fff; }
    .btn-secondary:hover { background: #444; }
    .btn-block { width: 100%; }
    .btn-sm { padding: 8px 16px; font-size: 12px; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 24px;
      background: #1a1a2e;
      border: none;
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .tab:hover { background: #252540; }
    .tab.active { background: #FFB800; color: #000; }
    
    /* Panels */
    .panel {
      display: none;
      background: #1a1a2e;
      border-radius: 12px;
      padding: 24px;
    }
    .panel.active { display: block; }
    .panel h2 { color: #FFB800; margin-bottom: 20px; font-size: 20px; }
    .panel h3 { color: #fff; margin: 20px 0 12px; font-size: 16px; }
    
    /* Cards */
    .card {
      background: #252540;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .card-title { font-weight: 600; color: #fff; }
    .card-subtitle { color: #888; font-size: 12px; }
    
    /* Tables */
    .table-container { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    th { color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    td { color: #fff; font-size: 14px; }
    tr:hover { background: #252540; }
    
    /* Status badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-success { background: #28a74520; color: #28a745; }
    .badge-warning { background: #ffc10720; color: #ffc107; }
    .badge-danger { background: #dc354520; color: #dc3545; }
    .badge-info { background: #17a2b820; color: #17a2b8; }
    .badge-primary { background: #FFB80020; color: #FFB800; }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: #252540;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: 700; color: #FFB800; }
    .stat-label { color: #888; font-size: 14px; margin-top: 4px; }
    
    /* Settings */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #252540;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .setting-info h4 { color: #fff; margin-bottom: 4px; }
    .setting-info p { color: #888; font-size: 13px; }
    
    /* Toggle Switch */
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #333;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.active { background: #28a745; }
    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: left 0.3s;
    }
    .toggle.active::after { left: 27px; }
    
    /* Address Form */
    .address-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .address-form .full-width { grid-column: span 2; }
    
    /* Alert */
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .alert-success { background: #28a74520; color: #28a745; border: 1px solid #28a745; }
    .alert-error { background: #dc354520; color: #dc3545; border: 1px solid #dc3545; }
    .alert-info { background: #17a2b820; color: #17a2b8; border: 1px solid #17a2b8; }
    
    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #888;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #FFB800;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Banner animations */
    @keyframes scrollBanner {
      0% { transform: translateX(0); }
      100% { transform: translateX(-33.33%); }
    }
    @keyframes blinkBanner {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Hidden */
    .hidden { display: none !important; }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: #1a1a2e;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 { color: #FFB800; margin-bottom: 20px; }
    .modal-close {
      float: right;
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }
    .modal-close:hover { color: #fff; }
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .info-item { background: #252540; padding: 12px; border-radius: 8px; }
    .info-item label { color: #888; font-size: 12px; display: block; margin-bottom: 4px; }
    .info-item span { color: #fff; font-weight: 500; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .address-form { grid-template-columns: 1fr; }
      .address-form .full-width { grid-column: span 1; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .info-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Modal pour g√©n√©rer √©tiquette -->
  <div id="labelModal" class="modal-overlay hidden">
    <div class="modal">
      <button class="modal-close" onclick="closeLabelModal()">&times;</button>
      <h3>üöö G√©n√©rer l'√©tiquette vers l'acheteur</h3>
      
      <div id="labelModalContent">
        <h4 style="color:#fff;margin-bottom:12px;">üì¶ Informations du colis</h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Produit</label>
            <span id="modalProduct">-</span>
          </div>
          <div class="info-item">
            <label>Service Expert ID</label>
            <span id="modalServiceId">-</span>
          </div>
        </div>
        
        <h4 style="color:#fff;margin:20px 0 12px;">üë§ Adresse de l'acheteur</h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Nom</label>
            <span id="modalBuyerName">-</span>
          </div>
          <div class="info-item">
            <label>Email</label>
            <span id="modalBuyerEmail">-</span>
          </div>
          <div class="info-item" style="grid-column: span 2;">
            <label>Adresse</label>
            <span id="modalBuyerAddress">-</span>
          </div>
          <div class="info-item">
            <label>Code postal</label>
            <span id="modalBuyerPostalCode">-</span>
          </div>
          <div class="info-item">
            <label>Ville</label>
            <span id="modalBuyerCity">-</span>
          </div>
        </div>
        
        <h4 style="color:#fff;margin:20px 0 12px;">üìê Dimensions du colis</h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Longueur (cm)</label>
            <input type="number" id="modalLength" class="form-group input" style="width:100%;padding:8px;background:#0f0f0f;border:1px solid #333;border-radius:4px;color:#fff;" value="30">
          </div>
          <div class="info-item">
            <label>Largeur (cm)</label>
            <input type="number" id="modalWidth" class="form-group input" style="width:100%;padding:8px;background:#0f0f0f;border:1px solid #333;border-radius:4px;color:#fff;" value="20">
          </div>
          <div class="info-item">
            <label>Hauteur (cm)</label>
            <input type="number" id="modalHeight" class="form-group input" style="width:100%;padding:8px;background:#0f0f0f;border:1px solid #333;border-radius:4px;color:#fff;" value="15">
          </div>
          <div class="info-item">
            <label>Poids (kg)</label>
            <input type="number" id="modalWeight" step="0.1" class="form-group input" style="width:100%;padding:8px;background:#0f0f0f;border:1px solid #333;border-radius:4px;color:#fff;" value="1">
          </div>
        </div>
        
        <h4 style="color:#fff;margin:20px 0 12px;">üöõ Transporteur</h4>
        <div class="form-group">
          <select id="modalCarrier" style="width:100%;padding:12px;background:#252540;color:#fff;border:1px solid #333;border-radius:8px;">
            <option value="colissimo">Colissimo</option>
            <option value="mondial_relay">Mondial Relay</option>
            <option value="chronopost">Chronopost</option>
            <option value="ups">UPS</option>
            <option value="dhl">DHL</option>
          </select>
        </div>
        
        <div style="margin-top:24px;display:flex;gap:12px;">
          <button class="btn btn-secondary" onclick="closeLabelModal()">Annuler</button>
          <button class="btn btn-primary" onclick="confirmGenerateLabel()" style="flex:1;">
            üè∑Ô∏è G√©n√©rer l'√©tiquette
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <h2>üîê Gearted Admin</h2>
    <div id="loginError" class="alert alert-error hidden"></div>
    <form id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" required placeholder="admin@gearted.com">
      </div>
      <div class="form-group">
        <label>Mot de passe</label>
        <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button type="submit" class="btn btn-primary btn-block">Se connecter</button>
    </form>
  </div>

  <!-- Admin Console -->
  <div id="adminConsole" class="container hidden">
    <div class="header">
      <h1>üéØ Gearted Admin Console</h1>
      <div>
        <span class="user-info" id="userInfo"></span>
        <button class="btn btn-secondary btn-sm" onclick="logout()">D√©connexion</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
      <button class="tab" onclick="showTab('banner')">üì¢ Bandeau Promo</button>
      <button class="tab" onclick="showTab('expert')">üõ°Ô∏è Gearted Expert</button>
      <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Param√®tres</button>
      <button class="tab" onclick="showTab('users')">üë• Utilisateurs</button>
      <button class="tab" onclick="showTab('products')">üì¶ Produits</button>
      <button class="tab" onclick="showTab('transactions')">üí∞ Transactions</button>
    </div>

    <!-- Dashboard Panel -->
    <div id="dashboardPanel" class="panel active">
      <h2>üìä Tableau de bord</h2>
      <div id="dashboardStats" class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statUsers">-</div>
          <div class="stat-label">Utilisateurs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statProducts">-</div>
          <div class="stat-label">Produits actifs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTransactions">-</div>
          <div class="stat-label">Transactions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statExpert">-</div>
          <div class="stat-label">Services Expert</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="loadDashboard()">üîÑ Rafra√Æchir</button>
    </div>

    <!-- Banner Promo Panel -->
    <div id="bannerPanel" class="panel">
      <h2>üì¢ Bandeau Promo</h2>
      <p style="color: #888; margin-bottom: 20px;">Configurez le bandeau d'information qui s'affiche en haut de la page d'accueil.</p>

      <div id="bannerAlert" class="alert hidden"></div>

      <!-- Preview -->
      <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 12px;">Aper√ßu</h3>
        <div id="bannerPreview" style="padding: 12px; text-align: center; border-radius: 8px; overflow: hidden;">
          <span id="bannerPreviewText">Aucun message configur√©</span>
        </div>
      </div>

      <!-- Settings Form -->
      <div class="card">
        <h3 style="margin-bottom: 16px;">Configuration</h3>

        <div class="form-group" style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="bannerEnabled" onchange="updateBannerPreview()" style="width: 20px; height: 20px;">
            <span>Activer le bandeau</span>
          </label>
        </div>

        <div class="form-group" style="margin-bottom: 16px;">
          <label for="bannerMessage">Message</label>
          <input type="text" id="bannerMessage" placeholder="Ex: -20% sur tout le site !" oninput="updateBannerPreview()" style="width: 100%; padding: 12px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 16px;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label for="bannerBgColor">Couleur de fond</label>
            <div style="display: flex; gap: 8px;">
              <input type="color" id="bannerBgColor" value="#FFB800" onchange="updateBannerPreview()" style="width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
              <input type="text" id="bannerBgColorText" value="#FFB800" onchange="document.getElementById('bannerBgColor').value = this.value; updateBannerPreview()" style="flex: 1; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #fff;">
            </div>
          </div>

          <div class="form-group">
            <label for="bannerTextColor">Couleur du texte</label>
            <div style="display: flex; gap: 8px;">
              <input type="color" id="bannerTextColor" value="#000000" onchange="updateBannerPreview()" style="width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
              <input type="text" id="bannerTextColorText" value="#000000" onchange="document.getElementById('bannerTextColor').value = this.value; updateBannerPreview()" style="flex: 1; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #fff;">
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label for="bannerFont">Police</label>
            <select id="bannerFont" onchange="updateBannerPreview()" style="width: 100%; padding: 12px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #fff;">
              <option value="default">Par d√©faut</option>
              <option value="stencil">Stencil (Militaire)</option>
              <option value="military">Military (Espac√©)</option>
              <option value="tactical">Tactical (Majuscules)</option>
              <option value="impact">Impact (Bold)</option>
              <option value="bold">Gras</option>
              <option value="courier">Courier (Mono)</option>
              <option value="arial-black">Arial Black</option>
              <option value="elegant">√âl√©gant (Fin)</option>
              <option value="compact">Compact (Serr√©)</option>
              <option value="wide">Wide (Tr√®s espac√©)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="bannerEffect">Effet</label>
            <select id="bannerEffect" onchange="updateBannerPreview()" style="width: 100%; padding: 12px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #fff;">
              <option value="none">Aucun</option>
              <option value="scroll">D√©filement horizontal</option>
              <option value="blink">Clignotement</option>
            </select>
          </div>
        </div>

        <div style="display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="saveBannerSettings()">üíæ Enregistrer</button>
          <button class="btn btn-secondary" onclick="loadBannerSettings()">üîÑ R√©initialiser</button>
        </div>
      </div>
    </div>

    <!-- Expert Services Panel -->
    <div id="expertPanel" class="panel">
      <h2>üõ°Ô∏è Services Gearted Expert</h2>
      <div id="expertAlert" class="alert hidden"></div>
      
      <div style="margin-bottom: 20px;">
        <select id="expertStatusFilter" onchange="loadExpertServices()" style="padding: 10px; background: #252540; color: #fff; border: 1px solid #333; border-radius: 8px;">
          <option value="">Tous les statuts</option>
          <option value="PENDING">En attente</option>
          <option value="AWAITING_SHIPMENT">Attente exp√©dition</option>
          <option value="IN_TRANSIT_TO_GEARTED">En transit ‚Üí Gearted</option>
          <option value="RECEIVED_BY_GEARTED">Re√ßu par Gearted</option>
          <option value="VERIFIED">V√©rifi√© ‚úì</option>
          <option value="IN_TRANSIT_TO_BUYER">En transit ‚Üí Acheteur</option>
          <option value="DELIVERED">Livr√©</option>
        </select>
      </div>

      <div id="expertList" class="table-container">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="panel">
      <h2>‚öôÔ∏è Param√®tres de la plateforme</h2>
      <div id="settingsAlert" class="alert hidden"></div>

      <h3>üí∞ Commissions Acheteur</h3>
      <div class="setting-row">
        <div class="setting-info">
          <h4>Activer les frais acheteur</h4>
          <p>Pr√©lever des frais de service sur les achats</p>
        </div>
        <div class="toggle" id="buyerCommissionToggle" onclick="toggleBuyerCommission()"></div>
      </div>
      <div class="card" style="margin-bottom: 20px;">
        <div class="address-form">
          <div class="form-group">
            <label>Taux acheteur (%)</label>
            <input type="number" id="buyerFeePercent" step="0.1" min="0" max="100" value="5" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="form-group">
            <label>Minimum acheteur (‚Ç¨)</label>
            <input type="number" id="buyerFeeMin" step="0.01" min="0" value="0.50" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
        </div>
      </div>

      <h3>üí∏ Commissions Vendeur</h3>
      <div class="setting-row">
        <div class="setting-info">
          <h4>Activer les frais vendeur</h4>
          <p>Pr√©lever une commission sur les ventes</p>
        </div>
        <div class="toggle" id="sellerCommissionToggle" onclick="toggleSellerCommission()"></div>
      </div>
      <div class="card" style="margin-bottom: 20px;">
        <div class="address-form">
          <div class="form-group">
            <label>Taux vendeur (%)</label>
            <input type="number" id="sellerFeePercent" step="0.1" min="0" max="100" value="8" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="form-group">
            <label>Minimum vendeur (‚Ç¨)</label>
            <input type="number" id="sellerFeeMin" step="0.01" min="0" value="0.50" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="saveCommissionSettings()">üíæ Sauvegarder les commissions</button>
      </div>

      <h3>‚≠ê Fonctions Premium</h3>
      <div class="setting-row">
        <div class="setting-info">
          <h4>Gearted Expert</h4>
          <p>Service de v√©rification premium pour les acheteurs</p>
        </div>
        <div class="toggle" id="expertToggle" onclick="toggleExpertFeature()"></div>
      </div>
      <div class="card" style="margin-bottom: 20px;">
        <div class="address-form">
          <div class="form-group">
            <label>Prix du service Expert (‚Ç¨)</label>
            <input type="number" id="expertPrice" step="0.01" min="0" value="19.90" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="full-width">
            <button class="btn btn-primary btn-sm" onclick="saveExpertPrice()">üíæ Sauvegarder le prix</button>
          </div>
        </div>
      </div>

      <h3>üõ°Ô∏è Assurance Protection (Casse/Perte)</h3>
      <div class="setting-row">
        <div class="setting-info">
          <h4>Activer l'assurance Protection</h4>
          <p>Permet aux acheteurs de souscrire une assurance casse/perte</p>
        </div>
        <div class="toggle" id="protectionToggle" onclick="toggleProtection()"></div>
      </div>
      <div class="card" style="margin-bottom: 20px;">
        <div class="address-form">
          <div class="form-group">
            <label>Prix de l'assurance (‚Ç¨)</label>
            <input type="number" id="protectionPrice" step="0.01" min="0" value="4.99" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="form-group">
            <label>Couverture max (‚Ç¨)</label>
            <input type="number" id="protectionMaxCoverage" step="1" min="0" value="500" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="form-group">
            <label>Franchise (‚Ç¨)</label>
            <input type="number" id="protectionFranchise" step="1" min="0" value="50" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="form-group">
            <label>Max sinistres/an</label>
            <input type="number" id="protectionMaxClaims" step="1" min="1" value="2" style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#fff;">
          </div>
          <div class="full-width">
            <button class="btn btn-primary btn-sm" onclick="saveProtectionSettings()">üíæ Sauvegarder les param√®tres</button>
          </div>
        </div>
      </div>

      <h3>üöÄ Syst√®me de Boost</h3>
      <div class="setting-row">
        <div class="setting-info">
          <h4>Activer le Boost</h4>
          <p>Permet aux utilisateurs de payer pour mettre en avant leurs annonces</p>
        </div>
        <div class="toggle" id="boostToggle" onclick="toggleBoost()"></div>
      </div>
      
      <div class="setting-row">
        <div class="setting-info">
          <h4>Section "Derni√®res annonces"</h4>
          <p>Afficher la section des derni√®res annonces sur la page d'accueil</p>
        </div>
        <div class="toggle" id="latestSectionToggle" onclick="toggleLatestSection()"></div>
      </div>

      <h3>üìç Adresse Gearted Expert</h3>
      <div class="card">
        <div class="address-form">
          <div class="form-group full-width">
            <label>Nom</label>
            <input type="text" id="addrName" placeholder="Gearted Expert">
          </div>
          <div class="form-group full-width">
            <label>Adresse</label>
            <input type="text" id="addrStreet" placeholder="123 Rue de l'Expertise">
          </div>
          <div class="form-group">
            <label>Code postal</label>
            <input type="text" id="addrPostalCode" placeholder="75001">
          </div>
          <div class="form-group">
            <label>Ville</label>
            <input type="text" id="addrCity" placeholder="Paris">
          </div>
          <div class="form-group">
            <label>Pays</label>
            <input type="text" id="addrCountry" value="France">
          </div>
          <div class="form-group">
            <label>T√©l√©phone</label>
            <input type="text" id="addrPhone" placeholder="+33 1 23 45 67 89">
          </div>
          <div class="form-group full-width">
            <label>Email</label>
            <input type="email" id="addrEmail" placeholder="expert@gearted.com">
          </div>
          <div class="full-width">
            <button class="btn btn-primary" onclick="saveGeartedAddress()">üíæ Sauvegarder l'adresse</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Panel -->
    <div id="usersPanel" class="panel">
      <h2>üë• Utilisateurs</h2>
      <div id="usersAlert" class="alert hidden"></div>
      <div id="usersList" class="table-container">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Products Panel -->
    <div id="productsPanel" class="panel">
      <h2>üì¶ Produits</h2>
      <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-danger btn-sm" onclick="cleanupSeededProducts()">üóëÔ∏è Supprimer donn√©es test</button>
        <button class="btn btn-danger" onclick="resetAllData()" style="background: #8B0000;">‚ò¢Ô∏è RESET COMPLET (Production)</button>
      </div>
      <div id="productsList" class="table-container">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Transactions Panel -->
    <div id="transactionsPanel" class="panel">
      <h2>üí∞ Transactions</h2>
      <div id="transactionsList" class="table-container">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <script>
    // State
    let token = localStorage.getItem('adminToken');
    let currentUser = null;
    let boostSettings = { enabled: false, showLatestSection: false };
    let expertSettings = { address: {} };

    // API Helper
    async function api(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      
      const response = await fetch(endpoint, { ...options, headers });
      if (response.status === 401) {
        logout();
        throw new Error('Session expir√©e');
      }
      return response.json();
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        const result = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(r => r.json());
        
        if (result.error || !result.success) throw new Error(result.error?.message || 'Erreur de connexion');
        
        const user = result.data?.user || result.user;
        const accessToken = result.data?.tokens?.accessToken || result.token;
        
        if (user?.role !== 'ADMIN') throw new Error('Acc√®s admin requis');
        
        token = accessToken;
        currentUser = user;
        localStorage.setItem('adminToken', token);
        showAdminConsole();
      } catch (err) {
        document.getElementById('loginError').textContent = err.message;
        document.getElementById('loginError').classList.remove('hidden');
      }
    });

    // Logout
    function logout() {
      token = null;
      currentUser = null;
      localStorage.removeItem('adminToken');
      document.getElementById('adminConsole').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    // Show admin console
    async function showAdminConsole() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminConsole').classList.remove('hidden');
      document.getElementById('userInfo').textContent = currentUser?.email || '';
      
      await loadDashboard();
      await loadSettings();
    }

    // Tab navigation
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Panel').classList.add('active');
      
      // Load data for tab
      switch(tabName) {
        case 'dashboard': loadDashboard(); break;
        case 'banner': loadBannerSettings(); break;
        case 'expert': loadExpertServices(); break;
        case 'settings': loadSettings(); break;
        case 'users': loadUsers(); break;
        case 'products': loadProducts(); break;
        case 'transactions': loadTransactions(); break;
      }
    }

    // Dashboard
    async function loadDashboard() {
      try {
        const [users, products, transactions, expert] = await Promise.all([
          api('/api/admin/users'),
          api('/api/admin/products/analyze'),
          api('/api/admin/transactions'),
          api('/api/admin/expert/all')
        ]);
        
        document.getElementById('statUsers').textContent = users.users?.length || 0;
        document.getElementById('statProducts').textContent = products.total || 0;
        document.getElementById('statTransactions').textContent = transactions.transactions?.length || 0;
        document.getElementById('statExpert').textContent = expert.services?.length || 0;
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }

    // ==========================================
    // PROMO BANNER
    // ==========================================

    let bannerSettings = {
      enabled: false,
      message: '',
      backgroundColor: '#FFB800',
      textColor: '#000000',
      fontFamily: 'default',
      effect: 'none'
    };

    async function loadBannerSettings() {
      try {
        const result = await api('/api/admin/settings/promo-banner');
        if (result.banner) {
          bannerSettings = result.banner;

          // Update form
          document.getElementById('bannerEnabled').checked = bannerSettings.enabled;
          document.getElementById('bannerMessage').value = bannerSettings.message || '';
          document.getElementById('bannerBgColor').value = bannerSettings.backgroundColor || '#FFB800';
          document.getElementById('bannerBgColorText').value = bannerSettings.backgroundColor || '#FFB800';
          document.getElementById('bannerTextColor').value = bannerSettings.textColor || '#000000';
          document.getElementById('bannerTextColorText').value = bannerSettings.textColor || '#000000';
          document.getElementById('bannerFont').value = bannerSettings.fontFamily || 'default';
          document.getElementById('bannerEffect').value = bannerSettings.effect || 'none';

          updateBannerPreview();
        }
      } catch (err) {
        console.error('Failed to load banner settings:', err);
        showBannerAlert('Erreur lors du chargement', 'error');
      }
    }

    function updateBannerPreview() {
      const preview = document.getElementById('bannerPreview');
      const previewText = document.getElementById('bannerPreviewText');

      const message = document.getElementById('bannerMessage').value || 'Aucun message configur√©';
      const bgColor = document.getElementById('bannerBgColor').value;
      const textColor = document.getElementById('bannerTextColor').value;
      const fontFamily = document.getElementById('bannerFont').value;
      const effect = document.getElementById('bannerEffect').value;
      const enabled = document.getElementById('bannerEnabled').checked;

      // Update color text inputs
      document.getElementById('bannerBgColorText').value = bgColor;
      document.getElementById('bannerTextColorText').value = textColor;

      // Set styles
      preview.style.backgroundColor = bgColor;
      preview.style.color = textColor;
      preview.style.opacity = enabled ? '1' : '0.5';

      // Set font
      const fontStyles = {
        'default': { family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', spacing: '0', weight: '600', transform: 'none' },
        'stencil': { family: '"Stencil Std", "Army", "Impact", sans-serif', spacing: '4px', weight: 'bold', transform: 'uppercase' },
        'military': { family: '-apple-system, BlinkMacSystemFont, sans-serif', spacing: '6px', weight: 'bold', transform: 'uppercase' },
        'tactical': { family: '-apple-system, BlinkMacSystemFont, sans-serif', spacing: '3px', weight: 'bold', transform: 'uppercase' },
        'impact': { family: 'Impact, Haettenschweiler, sans-serif', spacing: '1px', weight: 'normal', transform: 'none' },
        'bold': { family: '-apple-system, BlinkMacSystemFont, sans-serif', spacing: '0', weight: 'bold', transform: 'none' },
        'courier': { family: '"Courier New", Courier, monospace', spacing: '0', weight: 'bold', transform: 'none' },
        'arial-black': { family: '"Arial Black", Gadget, sans-serif', spacing: '1px', weight: 'normal', transform: 'none' },
        'elegant': { family: 'Georgia, "Times New Roman", serif', spacing: '2px', weight: '400', transform: 'none' },
        'compact': { family: '-apple-system, BlinkMacSystemFont, sans-serif', spacing: '-0.5px', weight: 'bold', transform: 'none' },
        'wide': { family: '-apple-system, BlinkMacSystemFont, sans-serif', spacing: '8px', weight: '600', transform: 'uppercase' }
      };
      const style = fontStyles[fontFamily] || fontStyles['default'];
      previewText.style.fontFamily = style.family;
      previewText.style.letterSpacing = style.spacing;
      previewText.style.fontWeight = style.weight;
      previewText.style.textTransform = style.transform;

      // Set effect
      previewText.style.animation = 'none';
      preview.innerHTML = ''; // Clear

      if (effect === 'scroll') {
        preview.innerHTML = `
          <div style="display: flex; animation: scrollBanner 10s linear infinite; white-space: nowrap;">
            <span style="padding: 0 50px;">${message}</span>
            <span style="padding: 0 50px;">${message}</span>
            <span style="padding: 0 50px;">${message}</span>
          </div>
        `;
        // Copy font styles to scrolling text
        const spans = preview.querySelectorAll('span');
        spans.forEach(span => {
          span.style.fontFamily = previewText.style.fontFamily;
          span.style.letterSpacing = previewText.style.letterSpacing;
          span.style.fontWeight = previewText.style.fontWeight;
        });
      } else if (effect === 'blink') {
        preview.innerHTML = `<span id="bannerPreviewText" style="animation: blinkBanner 1s ease-in-out infinite;">${message}</span>`;
        const span = preview.querySelector('span');
        span.style.fontFamily = previewText.style.fontFamily;
        span.style.letterSpacing = previewText.style.letterSpacing;
        span.style.fontWeight = previewText.style.fontWeight;
      } else {
        preview.innerHTML = `<span id="bannerPreviewText">${message}</span>`;
        const span = preview.querySelector('span');
        span.style.fontFamily = previewText.style.fontFamily;
        span.style.letterSpacing = previewText.style.letterSpacing;
        span.style.fontWeight = previewText.style.fontWeight;
      }
    }

    async function saveBannerSettings() {
      try {
        const settings = {
          enabled: document.getElementById('bannerEnabled').checked,
          message: document.getElementById('bannerMessage').value,
          backgroundColor: document.getElementById('bannerBgColor').value,
          textColor: document.getElementById('bannerTextColor').value,
          fontFamily: document.getElementById('bannerFont').value,
          effect: document.getElementById('bannerEffect').value
        };

        const result = await api('/api/admin/settings/promo-banner', {
          method: 'POST',
          body: JSON.stringify(settings)
        });

        showBannerAlert(result.message || 'Bandeau mis √† jour !', 'success');
        bannerSettings = result.banner;
      } catch (err) {
        showBannerAlert('Erreur: ' + err.message, 'error');
      }
    }

    function showBannerAlert(message, type) {
      const alert = document.getElementById('bannerAlert');
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.classList.remove('hidden');
      setTimeout(() => alert.classList.add('hidden'), 3000);
    }

    // Expert Services
    async function loadExpertServices() {
      const status = document.getElementById('expertStatusFilter').value;
      const url = status ? `/api/admin/expert/all?status=${status}` : '/api/admin/expert/all';
      
      try {
        const result = await api(url);
        const services = result.services || [];
        
        if (services.length === 0) {
          document.getElementById('expertList').innerHTML = '<p style="color:#888;padding:20px;">Aucun service expert trouv√©</p>';
          return;
        }
        
        const statusBadge = (status) => {
          const badges = {
            'PENDING': 'badge-warning',
            'AWAITING_SHIPMENT': 'badge-info',
            'IN_TRANSIT_TO_GEARTED': 'badge-info',
            'RECEIVED_BY_GEARTED': 'badge-primary',
            'VERIFIED': 'badge-success',
            'IN_TRANSIT_TO_BUYER': 'badge-info',
            'DELIVERED': 'badge-success'
          };
          return `<span class="badge ${badges[status] || 'badge-secondary'}">${status}</span>`;
        };
        
        let html = `<table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Produit</th>
              <th>Acheteur</th>
              <th>Statut</th>
              <th>Tracking vendeur</th>
              <th>Tracking acheteur</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        
        services.forEach(s => {
          html += `<tr>
            <td>${s.id.substring(0,8)}...</td>
            <td>${s.transaction?.product?.title || 'N/A'}</td>
            <td>${s.transaction?.buyer?.username || 'N/A'}</td>
            <td>${statusBadge(s.status)}</td>
            <td>${s.sellerTrackingNumber || '-'}</td>
            <td>${s.buyerTrackingNumber || '-'}</td>
            <td>
              ${s.status === 'IN_TRANSIT_TO_GEARTED' ? `<button class="btn btn-success btn-sm" onclick="markReceived('${s.id}')">üì¶ Re√ßu</button>` : ''}
              ${s.status === 'RECEIVED_BY_GEARTED' ? `<button class="btn btn-primary btn-sm" onclick="markVerified('${s.id}')">‚úì V√©rifi√©</button>` : ''}
              ${s.status === 'VERIFIED' ? `<button class="btn btn-info btn-sm" onclick="generateBuyerLabel('${s.id}')">üöö √âtiquette</button>` : ''}
              ${s.status === 'IN_TRANSIT_TO_BUYER' ? `<button class="btn btn-success btn-sm" onclick="markDelivered('${s.id}')">‚úÖ Livr√©</button>` : ''}
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        document.getElementById('expertList').innerHTML = html;
      } catch (err) {
        document.getElementById('expertList').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
      }
    }

    // Expert Actions
    async function markReceived(id) {
      if (!confirm('Confirmer la r√©ception du colis ?')) return;
      try {
        await api(`/api/admin/expert/mark-received/${id}`, { method: 'POST' });
        showAlert('expertAlert', 'Colis marqu√© comme re√ßu !', 'success');
        loadExpertServices();
      } catch (err) {
        showAlert('expertAlert', err.message, 'error');
      }
    }

    async function markVerified(id) {
      const notes = prompt('Notes de v√©rification (optionnel):');
      try {
        await api(`/api/admin/expert/verify/${id}`, {
          method: 'POST',
          body: JSON.stringify({ verificationPassed: true, verificationNotes: notes || '' })
        });
        showAlert('expertAlert', 'Produit v√©rifi√© avec succ√®s !', 'success');
        loadExpertServices();
      } catch (err) {
        showAlert('expertAlert', err.message, 'error');
      }
    }

    // Variable pour stocker l'ID du service en cours
    let currentLabelServiceId = null;
    let currentServiceData = null;

    async function generateBuyerLabel(id) {
      try {
        // R√©cup√©rer les d√©tails du service expert
        const result = await api(`/api/admin/expert/${id}/details`);
        const service = result.service || result;
        
        currentLabelServiceId = id;
        currentServiceData = service;
        
        // Remplir le modal
        document.getElementById('modalServiceId').textContent = id.substring(0, 12) + '...';
        document.getElementById('modalProduct').textContent = service.transaction?.product?.title || 'N/A';
        
        // Infos acheteur
        const buyer = service.transaction?.buyer;
        const shippingAddr = service.transaction?.shippingAddress || buyer?.shippingAddress || {};
        
        document.getElementById('modalBuyerName').textContent = buyer?.username || buyer?.firstName + ' ' + buyer?.lastName || 'N/A';
        document.getElementById('modalBuyerEmail').textContent = buyer?.email || 'N/A';
        document.getElementById('modalBuyerAddress').textContent = shippingAddr.street || shippingAddr.address || 'Non renseign√©e';
        document.getElementById('modalBuyerPostalCode').textContent = shippingAddr.postalCode || shippingAddr.zipCode || '-';
        document.getElementById('modalBuyerCity').textContent = shippingAddr.city || '-';
        
        // Dimensions du colis (si disponibles)
        const dims = service.transaction?.product?.parcelDimensions;
        if (dims) {
          document.getElementById('modalLength').value = dims.length || 30;
          document.getElementById('modalWidth').value = dims.width || 20;
          document.getElementById('modalHeight').value = dims.height || 15;
          document.getElementById('modalWeight').value = dims.weight || 1;
        }
        
        // Afficher le modal
        document.getElementById('labelModal').classList.remove('hidden');
        
      } catch (err) {
        showAlert('expertAlert', 'Erreur chargement d√©tails: ' + err.message, 'error');
      }
    }

    function closeLabelModal() {
      document.getElementById('labelModal').classList.add('hidden');
      currentLabelServiceId = null;
      currentServiceData = null;
    }

    async function confirmGenerateLabel() {
      if (!currentLabelServiceId) return;
      
      const carrier = document.getElementById('modalCarrier').value;
      const dimensions = {
        length: parseFloat(document.getElementById('modalLength').value),
        width: parseFloat(document.getElementById('modalWidth').value),
        height: parseFloat(document.getElementById('modalHeight').value),
        weight: parseFloat(document.getElementById('modalWeight').value)
      };
      
      try {
        const result = await api(`/api/admin/expert/${currentLabelServiceId}/generate-buyer-label`, {
          method: 'POST',
          body: JSON.stringify({ 
            carrierId: carrier,
            dimensions: dimensions
          })
        });
        
        closeLabelModal();
        
        if (result.label?.labelUrl) {
          // Ouvrir le PDF de l'√©tiquette
          window.open(result.label.labelUrl, '_blank');
        }
        
        showAlert('expertAlert', `‚úÖ √âtiquette g√©n√©r√©e ! Tracking: ${result.label?.trackingNumber || result.trackingNumber || 'Voir d√©tails'}`, 'success');
        loadExpertServices();
        
      } catch (err) {
        showAlert('expertAlert', 'Erreur g√©n√©ration √©tiquette: ' + err.message, 'error');
      }
    }

    async function markDelivered(id) {
      if (!confirm('Confirmer la livraison ?')) return;
      try {
        await api(`/api/admin/expert/mark-delivered/${id}`, { method: 'POST' });
        showAlert('expertAlert', 'Colis marqu√© comme livr√© !', 'success');
        loadExpertServices();
      } catch (err) {
        showAlert('expertAlert', err.message, 'error');
      }
    }

    // Settings
    let commissionSettings = { enabled: true, rate: 8, minAmount: 0.50 };
    let expertFeatureSettings = { enabled: true, price: 19.90 };
    let protectionSettings = { enabled: true, price: 4.99, maxCoverage: 500, franchise: 50, maxClaimsPerYear: 2 };

    async function loadSettings() {
      try {
        // Load admin settings (boost & latest section)
        const result = await api('/api/admin/settings');
        if (result.success) {
          boostSettings = {
            enabled: result.settings?.boost?.enabled ?? false,
            showLatestSection: result.settings?.latestSection?.visible ?? false
          };
        }

        document.getElementById('boostToggle').classList.toggle('active', boostSettings.enabled);
        document.getElementById('latestSectionToggle').classList.toggle('active', boostSettings.showLatestSection);

        // Load commission settings (buyer & seller)
        try {
          const commResult = await api('/api/admin/commissions/settings');
          if (commResult.success && commResult.settings) {
            commissionSettings = commResult.settings;
            // Buyer commissions
            document.getElementById('buyerCommissionToggle').classList.toggle('active', commissionSettings.buyerEnabled !== false);
            document.getElementById('buyerFeePercent').value = commissionSettings.buyerFeePercent || 5;
            document.getElementById('buyerFeeMin').value = commissionSettings.buyerFeeMin || 0.50;
            // Seller commissions
            document.getElementById('sellerCommissionToggle').classList.toggle('active', commissionSettings.sellerEnabled !== false);
            document.getElementById('sellerFeePercent').value = commissionSettings.sellerFeePercent || 8;
            document.getElementById('sellerFeeMin').value = commissionSettings.sellerFeeMin || 0.50;
          }
        } catch (e) { console.log('No commission settings yet'); }

        // Load expert settings (address + price)
        const expertResult = await api('/api/admin/expert/settings');
        if (expertResult.success && expertResult.settings) {
          expertFeatureSettings = {
            enabled: expertResult.settings.enabled !== false,
            price: expertResult.settings.price || 19.90
          };
          document.getElementById('expertToggle').classList.toggle('active', expertFeatureSettings.enabled);
          document.getElementById('expertPrice').value = expertFeatureSettings.price;

          if (expertResult.settings.address) {
            const addr = expertResult.settings.address;
            document.getElementById('addrName').value = addr.name || '';
            document.getElementById('addrStreet').value = addr.street || '';
            document.getElementById('addrPostalCode').value = addr.postalCode || '';
            document.getElementById('addrCity').value = addr.city || '';
            document.getElementById('addrCountry').value = addr.country || 'France';
            document.getElementById('addrPhone').value = addr.phone || '';
            document.getElementById('addrEmail').value = addr.email || '';
          }
        }

        // Load protection/insurance settings
        try {
          const protResult = await api('/api/admin/settings/protection');
          if (protResult.success && protResult.settings) {
            protectionSettings = protResult.settings;
            document.getElementById('protectionToggle').classList.toggle('active', protectionSettings.enabled !== false);
            document.getElementById('protectionPrice').value = protectionSettings.price || 4.99;
            document.getElementById('protectionMaxCoverage').value = protectionSettings.maxCoverage || 500;
            document.getElementById('protectionFranchise').value = protectionSettings.franchise || 50;
            document.getElementById('protectionMaxClaims').value = protectionSettings.maxClaimsPerYear || 2;
          }
        } catch (e) { console.log('No protection settings yet'); }
      } catch (err) {
        console.error('Settings error:', err);
      }
    }

    async function toggleBoost() {
      const newValue = !boostSettings.enabled;
      try {
        await api('/api/admin/settings/boost', {
          method: 'POST',
          body: JSON.stringify({ enabled: newValue })
        });
        boostSettings.enabled = newValue;
        document.getElementById('boostToggle').classList.toggle('active', newValue);
        showAlert('settingsAlert', `Boost ${newValue ? 'activ√©' : 'd√©sactiv√©'} !`, 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    async function toggleLatestSection() {
      const newValue = !boostSettings.showLatestSection;
      try {
        await api('/api/admin/settings/latest-section', {
          method: 'POST',
          body: JSON.stringify({ visible: newValue })
        });
        boostSettings.showLatestSection = newValue;
        document.getElementById('latestSectionToggle').classList.toggle('active', newValue);
        showAlert('settingsAlert', `Section "Derni√®res annonces" ${newValue ? 'affich√©e' : 'masqu√©e'} !`, 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    // Commissions Acheteur
    async function toggleBuyerCommission() {
      const newValue = !(commissionSettings.buyerEnabled !== false);
      try {
        await api('/api/admin/commissions/settings', {
          method: 'PUT',
          body: JSON.stringify({ 
            buyerEnabled: newValue,
            sellerEnabled: commissionSettings.sellerEnabled,
            buyerFeePercent: commissionSettings.buyerFeePercent,
            sellerFeePercent: commissionSettings.sellerFeePercent,
            buyerFeeMin: commissionSettings.buyerFeeMin,
            sellerFeeMin: commissionSettings.sellerFeeMin
          })
        });
        commissionSettings.buyerEnabled = newValue;
        document.getElementById('buyerCommissionToggle').classList.toggle('active', newValue);
        showAlert('settingsAlert', `Commissions acheteur ${newValue ? 'activ√©es' : 'd√©sactiv√©es'} !`, 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    // Commissions Vendeur
    async function toggleSellerCommission() {
      const newValue = !(commissionSettings.sellerEnabled !== false);
      try {
        await api('/api/admin/commissions/settings', {
          method: 'PUT',
          body: JSON.stringify({ 
            buyerEnabled: commissionSettings.buyerEnabled,
            sellerEnabled: newValue,
            buyerFeePercent: commissionSettings.buyerFeePercent,
            sellerFeePercent: commissionSettings.sellerFeePercent,
            buyerFeeMin: commissionSettings.buyerFeeMin,
            sellerFeeMin: commissionSettings.sellerFeeMin
          })
        });
        commissionSettings.sellerEnabled = newValue;
        document.getElementById('sellerCommissionToggle').classList.toggle('active', newValue);
        showAlert('settingsAlert', `Commissions vendeur ${newValue ? 'activ√©es' : 'd√©sactiv√©es'} !`, 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    async function saveCommissionSettings() {
      const buyerRate = parseFloat(document.getElementById('buyerFeePercent').value);
      const buyerMin = parseFloat(document.getElementById('buyerFeeMin').value);
      const sellerRate = parseFloat(document.getElementById('sellerFeePercent').value);
      const sellerMin = parseFloat(document.getElementById('sellerFeeMin').value);
      try {
        await api('/api/admin/commissions/settings', {
          method: 'PUT',
          body: JSON.stringify({ 
            buyerEnabled: commissionSettings.buyerEnabled !== false,
            sellerEnabled: commissionSettings.sellerEnabled !== false,
            buyerFeePercent: buyerRate,
            sellerFeePercent: sellerRate,
            buyerFeeMin: buyerMin,
            sellerFeeMin: sellerMin
          })
        });
        commissionSettings.buyerFeePercent = buyerRate;
        commissionSettings.buyerFeeMin = buyerMin;
        commissionSettings.sellerFeePercent = sellerRate;
        commissionSettings.sellerFeeMin = sellerMin;
        showAlert('settingsAlert', 'Tous les param√®tres de commission sauvegard√©s !', 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    // Expert Feature Toggle
    async function toggleExpertFeature() {
      const newValue = !expertFeatureSettings.enabled;
      try {
        await api('/api/admin/expert/settings', {
          method: 'PUT',
          body: JSON.stringify({ 
            enabled: newValue,
            price: expertFeatureSettings.price
          })
        });
        expertFeatureSettings.enabled = newValue;
        document.getElementById('expertToggle').classList.toggle('active', newValue);
        showAlert('settingsAlert', `Gearted Expert ${newValue ? 'activ√©' : 'd√©sactiv√©'} !`, 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    async function saveExpertPrice() {
      const price = parseFloat(document.getElementById('expertPrice').value);
      try {
        await api('/api/admin/expert/settings', {
          method: 'PUT',
          body: JSON.stringify({ 
            enabled: expertFeatureSettings.enabled,
            price: price
          })
        });
        expertFeatureSettings.price = price;
        showAlert('settingsAlert', 'Prix du service Expert sauvegard√© !', 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    async function saveGeartedAddress() {
      const address = {
        name: document.getElementById('addrName').value,
        street: document.getElementById('addrStreet').value,
        postalCode: document.getElementById('addrPostalCode').value,
        city: document.getElementById('addrCity').value,
        country: document.getElementById('addrCountry').value,
        phone: document.getElementById('addrPhone').value,
        email: document.getElementById('addrEmail').value
      };

      try {
        await api('/api/admin/expert/settings', {
          method: 'PUT',
          body: JSON.stringify({ address, enabled: expertFeatureSettings.enabled, price: expertFeatureSettings.price })
        });
        showAlert('settingsAlert', 'Adresse Gearted sauvegard√©e !', 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    // Protection/Insurance Toggle
    async function toggleProtection() {
      const newValue = !protectionSettings.enabled;
      try {
        await api('/api/admin/settings/protection', {
          method: 'POST',
          body: JSON.stringify({
            enabled: newValue,
            price: protectionSettings.price,
            maxCoverage: protectionSettings.maxCoverage,
            franchise: protectionSettings.franchise,
            maxClaimsPerYear: protectionSettings.maxClaimsPerYear
          })
        });
        protectionSettings.enabled = newValue;
        document.getElementById('protectionToggle').classList.toggle('active', newValue);
        showAlert('settingsAlert', `Assurance Protection ${newValue ? 'activ√©e' : 'd√©sactiv√©e'} !`, 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    async function saveProtectionSettings() {
      const price = parseFloat(document.getElementById('protectionPrice').value);
      const maxCoverage = parseFloat(document.getElementById('protectionMaxCoverage').value);
      const franchise = parseFloat(document.getElementById('protectionFranchise').value);
      const maxClaimsPerYear = parseInt(document.getElementById('protectionMaxClaims').value);

      try {
        await api('/api/admin/settings/protection', {
          method: 'POST',
          body: JSON.stringify({
            enabled: protectionSettings.enabled,
            price: price,
            maxCoverage: maxCoverage,
            franchise: franchise,
            maxClaimsPerYear: maxClaimsPerYear
          })
        });
        protectionSettings.price = price;
        protectionSettings.maxCoverage = maxCoverage;
        protectionSettings.franchise = franchise;
        protectionSettings.maxClaimsPerYear = maxClaimsPerYear;
        showAlert('settingsAlert', 'Param√®tres de l\'assurance Protection sauvegard√©s !', 'success');
      } catch (err) {
        showAlert('settingsAlert', err.message, 'error');
      }
    }

    // Users
    async function loadUsers() {
      try {
        const result = await api('/api/admin/users');
        const users = result.users || [];
        
        let html = `<table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>R√¥le</th>
              <th>Premium</th>
              <th>Exempt comm.</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        
        users.forEach(u => {
          const isPremium = u.isPremium;
          const isExempt = u.exemptFromCommissions;
          html += `<tr>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td><span class="badge ${u.role === 'ADMIN' ? 'badge-danger' : 'badge-info'}">${u.role}</span></td>
            <td>
              <span class="badge ${isPremium ? 'badge-success' : 'badge-secondary'}">${isPremium ? '‚≠ê OUI' : 'Non'}</span>
            </td>
            <td>
              <span class="badge ${isExempt ? 'badge-warning' : 'badge-secondary'}">${isExempt ? '‚úì OUI' : 'Non'}</span>
            </td>
            <td>
              <button class="btn ${isPremium ? 'btn-danger' : 'btn-success'} btn-sm" onclick="toggleUserPremium('${u.id}', ${!isPremium})">
                ${isPremium ? '‚ùå Retirer Premium' : '‚≠ê Premium'}
              </button>
              <button class="btn ${isExempt ? 'btn-warning' : 'btn-secondary'} btn-sm" onclick="toggleUserCommission('${u.id}', ${!isExempt})">
                ${isExempt ? 'üí∞ Activer comm.' : 'üö´ Exempter'}
              </button>
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        document.getElementById('usersList').innerHTML = html;
      } catch (err) {
        document.getElementById('usersList').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
      }
    }

    async function toggleUserPremium(userId, isPremium) {
      const duration = isPremium ? prompt('Dur√©e en jours (vide = permanent):') : null;
      let premiumUntil = null;
      if (duration && !isNaN(parseInt(duration))) {
        premiumUntil = new Date(Date.now() + parseInt(duration) * 24 * 60 * 60 * 1000).toISOString();
      }
      
      try {
        await api(`/api/admin/users/${userId}/premium`, {
          method: 'PUT',
          body: JSON.stringify({ isPremium, premiumUntil })
        });
        showAlert('usersAlert', `Premium ${isPremium ? 'activ√©' : 'd√©sactiv√©'} !`, 'success');
        loadUsers();
      } catch (err) {
        showAlert('usersAlert', err.message, 'error');
      }
    }

    async function toggleUserCommission(userId, exempt) {
      try {
        await api(`/api/admin/users/${userId}/commissions`, {
          method: 'PUT',
          body: JSON.stringify({ exemptFromCommissions: exempt })
        });
        showAlert('usersAlert', `Exemption de commission ${exempt ? 'activ√©e' : 'd√©sactiv√©e'} !`, 'success');
        loadUsers();
      } catch (err) {
        showAlert('usersAlert', err.message, 'error');
      }
    }

    // Products
    async function loadProducts() {
      try {
        const result = await api('/api/admin/products/analyze');
        
        let html = `<div class="stats-grid" style="margin-bottom:20px;">
          <div class="stat-card"><div class="stat-value">${result.total}</div><div class="stat-label">Total</div></div>
          <div class="stat-card"><div class="stat-value">${result.real?.count || 0}</div><div class="stat-label">R√©els</div></div>
          <div class="stat-card"><div class="stat-value">${result.seeded?.count || 0}</div><div class="stat-label">Donn√©es test</div></div>
        </div>`;
        
        html += `<table>
          <thead>
            <tr><th>ID</th><th>Titre</th><th>Vendeur</th><th>Cr√©√© le</th></tr>
          </thead>
          <tbody>`;
        
        (result.real?.products || []).forEach(p => {
          html += `<tr>
            <td>${p.id.substring(0,8)}...</td>
            <td>${p.title}</td>
            <td>${p.seller}</td>
            <td>${new Date(p.createdAt).toLocaleDateString('fr-FR')}</td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        document.getElementById('productsList').innerHTML = html;
      } catch (err) {
        document.getElementById('productsList').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
      }
    }

    async function cleanupSeededProducts() {
      // Double confirmation pour √©viter les accidents
      if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nVous √™tes sur le point de supprimer TOUTES les donn√©es de test.\n\nCette action est IRR√âVERSIBLE !\n\n√ätes-vous s√ªr de vouloir continuer ?')) return;

      // Deuxi√®me confirmation
      const confirmText = prompt('Pour confirmer, tapez "SUPPRIMER" en majuscules :');
      if (confirmText !== 'SUPPRIMER') {
        alert('Suppression annul√©e. Le texte de confirmation ne correspond pas.');
        return;
      }

      try {
        await api('/api/admin/products/cleanup', { method: 'DELETE' });
        showAlert('productsList', '‚úÖ Donn√©es de test supprim√©es avec succ√®s !', 'success');
        loadProducts();
        loadDashboard(); // Rafra√Æchir aussi le dashboard
      } catch (err) {
        alert('Erreur: ' + err.message);
      }
    }

    async function resetAllData() {
      // Triple confirmation pour cette action TR√àS dangereuse
      if (!confirm('‚ò¢Ô∏è ATTENTION - RESET COMPLET ‚ò¢Ô∏è\n\nVous √™tes sur le point de SUPPRIMER TOUTES LES DONN√âES :\n\n‚Ä¢ Tous les utilisateurs (sauf admins)\n‚Ä¢ Tous les produits\n‚Ä¢ Toutes les transactions\n‚Ä¢ Tous les messages\n‚Ä¢ Toutes les notifications\n‚Ä¢ Tous les avis\n\nLes param√®tres de la plateforme seront conserv√©s.\n\nCette action est IRR√âVERSIBLE !\n\n√ätes-vous ABSOLUMENT s√ªr ?')) return;

      // Deuxi√®me confirmation
      if (!confirm('üö® DERNI√àRE CHANCE üö®\n\nCette action va effacer TOUTES les donn√©es utilisateurs.\n\nVoulez-vous vraiment continuer ?')) return;

      // Troisi√®me confirmation par texte
      const confirmText = prompt('Pour confirmer le RESET COMPLET, tapez exactement :\n\nRESET_ALL_DATA');
      if (confirmText !== 'RESET_ALL_DATA') {
        alert('Reset annul√©. Le texte de confirmation ne correspond pas.');
        return;
      }

      try {
        const result = await api('/api/admin/reset-all', {
          method: 'DELETE',
          body: JSON.stringify({ confirm: 'RESET_ALL_DATA' })
        });

        alert(`‚úÖ RESET COMPLET EFFECTU√â !\n\nDonn√©es supprim√©es :\n‚Ä¢ ${result.deleted.users} utilisateurs\n‚Ä¢ ${result.deleted.products} produits\n‚Ä¢ ${result.deleted.transactions} transactions\n‚Ä¢ ${result.deleted.messages} messages\n‚Ä¢ ${result.deleted.conversations} conversations\n‚Ä¢ ${result.deleted.notifications} notifications\n‚Ä¢ ${result.deleted.favorites} favoris\n‚Ä¢ ${result.deleted.images} images\n‚Ä¢ ${result.deleted.boosts} boosts\n‚Ä¢ ${result.deleted.shipments} exp√©ditions\n‚Ä¢ ${result.deleted.stripeAccounts} comptes Stripe\n‚Ä¢ ${result.deleted.addresses} adresses\n\nL'application est pr√™te pour la production.`);

        loadProducts();
        loadTransactions();
        loadUsers();
        loadDashboard();
      } catch (err) {
        alert('Erreur: ' + err.message);
      }
    }

    // Transactions
    async function loadTransactions() {
      try {
        const result = await api('/api/admin/transactions');
        const transactions = result.transactions || [];
        
        if (transactions.length === 0) {
          document.getElementById('transactionsList').innerHTML = '<p style="color:#888;padding:20px;">Aucune transaction</p>';
          return;
        }
        
        let html = `<table>
          <thead>
            <tr><th>ID</th><th>Produit</th><th>Acheteur</th><th>Montant</th><th>Statut</th><th>Date</th></tr>
          </thead>
          <tbody>`;
        
        transactions.forEach(t => {
          const statusClass = {
            'SUCCEEDED': 'badge-success',
            'COMPLETED': 'badge-success',
            'PENDING': 'badge-warning',
            'PROCESSING': 'badge-info',
            'CANCELLED': 'badge-danger',
            'FAILED': 'badge-danger',
            'REFUNDED': 'badge-danger'
          }[t.status] || 'badge-secondary';
          
          // Handle amount as string, number, or Decimal
          const amount = parseFloat(t.amount) || 0;
          
          html += `<tr>
            <td>${(t.id || '').substring(0,8)}...</td>
            <td>${t.product?.title || 'N/A'}</td>
            <td>${t.buyer?.username || 'N/A'}</td>
            <td>${amount.toFixed(2)} ‚Ç¨</td>
            <td><span class="badge ${statusClass}">${t.status}</span></td>
            <td>${t.createdAt ? new Date(t.createdAt).toLocaleDateString('fr-FR') : 'N/A'}</td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        document.getElementById('transactionsList').innerHTML = html;
      } catch (err) {
        document.getElementById('transactionsList').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
      }
    }

    // Helpers
    function showAlert(containerId, message, type) {
      const container = document.getElementById(containerId);
      container.className = `alert alert-${type}`;
      container.textContent = message;
      container.classList.remove('hidden');
      setTimeout(() => container.classList.add('hidden'), 5000);
    }

    // Init
    if (token) {
      // Verify token and load console
      api('/api/auth/me').then(result => {
        const user = result.data?.user || result.user;
        if (user?.role === 'ADMIN') {
          currentUser = user;
          showAdminConsole();
        } else {
          logout();
        }
      }).catch(() => logout());
    }
  </script>
</body>
</html>
