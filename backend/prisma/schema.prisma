// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String  @id @default(cuid())
  email     String  @unique
  username  String  @unique
  password  String? // Optional pour OAuth users
  firstName String?
  lastName  String?
  avatar    String?
  phone     String?

  // OAuth fields
  provider     String?   // "local", "discord", etc.
  providerId   String?   // Discord user ID
  providerData Json?     // Données brutes du provider

  // Account status
  isEmailVerified Boolean  @default(false)
  isActive        Boolean  @default(true)
  role            UserRole @default(USER)

  // Profile information
  bio      String?
  location String?
  badges   String[] @default([]) // Discord badges/roles

  // Security
  refreshToken String?

  // Onboarding
  hasSeenWelcome Boolean @default(false)

  // Admin features
  exemptFromCommissions Boolean? @default(false)
  isPremium            Boolean? @default(false)
  premiumUntil         DateTime?

  @@unique([provider, providerId]) // Éviter les doublons OAuth
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products         Product[]
  sentMessages     Message[]
  conversations    Conversation[] @relation("ConversationParticipants")
  stripeAccount    StripeAccount?
  transactions     Transaction[]
  shippingAddresses ShippingAddress[]

  @@map("users")
}

// Product Management
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products Product[]
  
  @@map("categories")
}

// Chat & Messaging
model Conversation {
  id           String    @id @default(cuid())
  participants User[]    @relation("ConversationParticipants")
  messages     Message[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String
  sentAt         DateTime     @default(now())

  @@map("messages")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   // Utilisateur qui reçoit la notification
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean  @default(false)
  data      Json?    // Données additionnelles (transactionId, productId, etc.)
  createdAt DateTime @default(now())

  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SHIPPING_UPDATE
  PAYMENT_UPDATE
  MESSAGE
}

model Brand {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  logo        String?
  isActive    Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products      Product[]
  manufacturers Manufacturer[]
  
  @@map("brands")
}

// Airsoft Weapon Manufacturers/Constructors
model Manufacturer {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  country     String?
  description String?
  logo        String?
  website     String?
  popularity  Int     @default(0) // For ranking top constructors
  isActive    Boolean @default(true)
  
  // Relation to Brand (optional - some manufacturers are also brands)
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  weaponModels WeaponModel[]
  
  @@map("manufacturers")
}

// Weapon Models (specific guns from manufacturers)
model WeaponModel {
  id             String       @id @default(cuid())
  name           String
  manufacturerId String
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])
  
  weaponType WeaponType
  model      String // e.g., "AK-47", "M4A1"
  version    String? // e.g., "V2", "2023"
  
  // Technical specifications
  gearboxType  String? // e.g., "V2", "V3"
  hopUpType    String?
  barrelLength Float? // in mm
  magazineType String?
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  compatibleParts PartCompatibility[]
  
  @@unique([manufacturerId, model, version])
  @@map("weapon_models")
}

// Compatible Parts and Accessories
model Part {
  id           String   @id @default(cuid())
  name         String
  manufacturer String
  partType     PartType
  
  // Specifications
  specifications String? // JSON string for flexible specs
  price          Decimal?
  priceRange     String? // e.g., "$20-$30"
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  compatibility PartCompatibility[]
  
  @@map("parts")
}

// Compatibility Matrix
model PartCompatibility {
  id String @id @default(cuid())
  
  weaponModelId String
  weaponModel   WeaponModel @relation(fields: [weaponModelId], references: [id])
  
  partId String
  part   Part   @relation(fields: [partId], references: [id])
  
  // Compatibility score (0-100)
  compatibilityScore Int @default(100)
  
  // Additional info
  notes                String?
  requiresModification Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([weaponModelId, partId])
  @@map("part_compatibility")
}

model Product {
  id          String @id @default(cuid())
  title       String
  description String
  slug        String @unique

  // Basic information
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id])

  // Seller information
  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id])

  // Product details
  condition ProductCondition
  price     Decimal
  currency  String           @default("EUR")

  // Product status
  status   ProductStatus @default(DRAFT)
  isActive Boolean       @default(true)
  soldAt   DateTime?     // Date when product was marked as sold (payment succeeded)
  deletionScheduledAt DateTime? // Auto-delete 3 days after soldAt

  // Location and shipping
  location         String?
  shippingIncluded Boolean  @default(false)
  shippingCost     Decimal?

  // Catégorie d'expédition (obligatoire pour les annonces)
  shippingCategory ShippingCategory? // CAT_1, CAT_2, CAT_3, CAT_4, CAT_5, CAT_VOLUMINEUX

  // Dimensions personnalisées (uniquement pour CAT_VOLUMINEUX)
  customParcelLength Float? // Longueur en cm
  customParcelWidth  Float? // Largeur en cm
  customParcelHeight Float? // Hauteur en cm
  customParcelWeight Float? // Poids en kg

  // Ancien système (deprecated, gardé pour compatibilité)
  parcelDimensionsId String? // Lien vers les dimensions du colis
  parcelDimensions ParcelDimensions? @relation(fields: [parcelDimensionsId], references: [id])

  // Payment tracking
  paymentCompleted Boolean   @default(false) // Paiement réussi
  paymentCompletedAt DateTime? // Date du paiement

  // Analytics
  views Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  images       ProductImage[]
  transactions Transaction[]
  shipments    Shipment[]
  boosts       ProductBoost[]

  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url       String
  alt       String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)
  
  createdAt DateTime @default(now())
  
  @@map("product_images")
}

model Favorite {
  id           String   @id @default(cuid())
  userId       String
  productId    String
  productTitle String?
  productImage String?
  createdAt    DateTime @default(now())
  
  @@unique([userId, productId])
  @@map("favorites")
}

// Enums
enum UserRole {
  USER
  SELLER
  ADMIN
  MODERATOR
}

enum ProductCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
  FOR_PARTS
}

enum ProductStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  SOLD
  EXPIRED
  SUSPENDED
  DELETED
}

enum WeaponType {
  ASSAULT_RIFLE
  SMG
  SNIPER_RIFLE
  PISTOL
  LMG
  SHOTGUN
  DMR
  CARBINE
}

enum PartType {
  MAGAZINE
  BARREL
  HOP_UP
  GEARBOX
  MOTOR
  BATTERY
  OPTIC
  STOCK
  GRIP
  SUPPRESSOR
  RAIL_SYSTEM
  TRIGGER
  PISTON
  SPRING
  CYLINDER
  NOZZLE
  TAPPET_PLATE
}

// Catégories d'expédition pour le calcul des frais de port
enum ShippingCategory {
  CAT_1          // Airsoft léger - < 1 kg
  CAT_2          // Standard - 1 à 2,5 kg
  CAT_3          // Standard+ / Fusils - 2,5 à 4 kg
  CAT_4          // Lourd / Sniper - 4 à 8 kg
  CAT_5          // Kit / Bundle - 8 à 15 kg
  CAT_VOLUMINEUX // Colis volumineux - dimensions personnalisées
}

// Stripe Connect Models
model StripeAccount {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe Connect account ID
  stripeAccountId String  @unique
  accountType     String  @default("express") // "express" or "standard"

  // Account status
  chargesEnabled  Boolean @default(false)
  payoutsEnabled  Boolean @default(false)
  detailsSubmitted Boolean @default(false)

  // Onboarding
  onboardingComplete Boolean @default(false)

  // Metadata
  country  String?
  currency String  @default("eur")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stripe_accounts")
}

model Transaction {
  id        String @id @default(cuid())

  // Product and buyer
  productId String
  product   Product @relation(fields: [productId], references: [id])
  buyerId   String
  buyer     User    @relation(fields: [buyerId], references: [id])

  // Payment info - Prix de base
  amount           Decimal // Prix du produit
  currency         String  @default("EUR")
  
  // Commission structure (5% acheteur + 5% vendeur = 10% total)
  buyerFeePercent  Decimal @default(5.0)   // Commission acheteur (5%)
  sellerFeePercent Decimal @default(5.0)   // Commission vendeur (5%)
  buyerFee         Decimal @default(0)     // Montant commission acheteur
  sellerFee        Decimal @default(0)     // Montant commission vendeur
  
  platformFee      Decimal // Commission totale Gearted (buyerFee + sellerFee)
  sellerAmount     Decimal // Montant pour le vendeur (amount - sellerFee)
  totalPaid        Decimal? // Montant total payé par l'acheteur (amount + buyerFee)

  // Stripe IDs
  paymentIntentId  String  @unique
  transferId       String? // Transfer to seller's connected account

  // Status
  status TransactionStatus @default(PENDING)

  // Shipping
  shippingAddress  Json?
  trackingNumber   String?
  shippingRateId   String?  // ID du tarif choisi (mondial-relay-standard, etc.)
  shippingCost     Decimal? // Coût de livraison payé par l'acheteur
  shippingProvider String?  // Transporteur (Mondial Relay, Colissimo, etc.)

  // Buyer's shipping preference (set by buyer, used by seller to generate label)
  selectedShippingRate String? // Rate ID selected by buyer (before label generation)
  selectedRelayPoint   Json?   // Relay point details if Point Relais selected

  // Premium services liés
  hasProtection    Boolean @default(false) // Gearted Protect
  hasExpert        Boolean @default(false) // Gearted Expert
  
  // Relations premium
  protection       TransactionProtection?
  expertService    ExpertService?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

// Dimensions du colis (renseignées par le vendeur)
model ParcelDimensions {
  id        String @id @default(cuid())
  
  // Dimensions en cm
  length Float // Longueur
  width  Float // Largeur  
  height Float // Hauteur
  weight Float // Poids en kg
  
  // Optionnel: lien vers catalogue prédéfini
  weaponModelId    String?
  manufacturerId   String?
  name             String? // Ex: "Boîte Tokyo Marui M4"
  isFromCatalog    Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products  Product[]
  shipments Shipment[]
  
  @@map("parcel_dimensions")
}

// Expéditions
model Shipment {
  id String @id @default(cuid())
  
  // Produit et utilisateurs
  productId String
  product   Product @relation(fields: [productId], references: [id])
  buyerId   String
  sellerId  String
  
  // Numéro de commande
  orderNumber String @unique
  
  // Shippo tracking
  shippoObjectId String?
  trackingNumber String?
  labelUrl       String?
  trackingStatus String? @default("UNKNOWN")
  
  // Adresses
  fromAddress Json // Adresse vendeur
  toAddress   Json // Adresse acheteur
  
  // Dimensions du colis
  parcelId String?
  parcel   ParcelDimensions? @relation(fields: [parcelId], references: [id])
  
  // Transporteur
  carrier           String?
  serviceLevelToken String?
  estimatedDays     Int?
  
  // Montant
  amount   Decimal
  currency String  @default("EUR")
  
  // Statut
  status String @default("PENDING") // PENDING, LABEL_CREATED, SHIPPED, DELIVERED, CANCELLED
  isPaid Boolean @default(false)
  
  // Métadonnées
  metadata Json?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  shippedAt   DateTime?
  deliveredAt DateTime?
  
  @@map("shipments")
}

// Adresses de livraison sauvegardées par utilisateur
model ShippingAddress {
  id String @id @default(cuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informations d'adresse
  name     String
  street1  String
  street2  String?
  city     String
  state    String?
  zip      String
  country  String
  phone    String
  email    String
  
  // Adresse par défaut
  isDefault Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("shipping_addresses")
}

// ==========================================
// PREMIUM FEATURES - Gearted Monetization
// ==========================================

// Product Boost - Mise en avant des annonces
model ProductBoost {
  id        String @id @default(cuid())
  
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String // Vendeur qui a payé le boost
  
  // Type de boost
  boostType BoostType
  
  // Prix payé
  price    Decimal
  currency String  @default("EUR")
  
  // Période de boost
  startsAt  DateTime @default(now())
  endsAt    DateTime
  
  // Stripe payment
  paymentIntentId String?
  
  // Status
  status BoostStatus @default(PENDING)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("product_boosts")
}

enum BoostType {
  BOOST_24H  // 1.99€ - 24 heures de mise en avant
  BOOST_7D   // 4.99€ - 7 jours de mise en avant
}

enum BoostStatus {
  PENDING    // En attente de paiement
  ACTIVE     // Boost actif
  EXPIRED    // Boost terminé
  CANCELLED  // Boost annulé
}

// Gearted Protect - Assurance transaction (sans transit physique)
model TransactionProtection {
  id String @id @default(cuid())
  
  transactionId String @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Prix fixe: 3.99€
  price    Decimal @default(3.99)
  currency String  @default("EUR")
  
  // Stripe payment
  paymentIntentId String?
  
  // Status de la protection
  status ProtectionStatus @default(PENDING)
  
  // En cas de litige
  claimReason     String?
  claimDescription String?
  claimAt         DateTime?
  claimResolvedAt DateTime?
  claimResolution String?
  refundAmount    Decimal?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("transaction_protections")
}

enum ProtectionStatus {
  PENDING         // En attente de paiement
  ACTIVE          // Protection active
  CLAIM_OPENED    // Litige ouvert
  CLAIM_RESOLVED  // Litige résolu
  EXPIRED         // Protection expirée (14 jours après livraison)
  CANCELLED       // Annulé
}

// Gearted Expert - Vérification physique par expert (transit par Gearted)
model ExpertService {
  id String @id @default(cuid())
  
  transactionId String @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Prix fixe: 19.90€
  price    Decimal @default(19.90)
  currency String  @default("EUR")
  
  // Stripe payment
  paymentIntentId String?
  
  // Status du service
  status ExpertServiceStatus @default(PENDING)
  
  // Tracking vendeur -> Gearted
  sellerTrackingNumber String?
  sellerShippedAt      DateTime?
  receivedByGeartedAt  DateTime?
  
  // Vérification par l'expert
  verifiedAt          DateTime?
  verifiedBy          String?   // ID de l'expert/admin
  verificationNotes   String?
  verificationPhotos  String[]  @default([])
  verificationPassed  Boolean?
  
  // Tracking Gearted -> Acheteur
  buyerTrackingNumber String?
  shippedToBuyerAt    DateTime?
  deliveredToBuyerAt  DateTime?
  
  // En cas de problème détecté
  issueDetected       Boolean   @default(false)
  issueDescription    String?
  issueResolution     String?
  refundAmount        Decimal?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("expert_services")
}

enum ExpertServiceStatus {
  PENDING              // En attente de paiement
  AWAITING_SHIPMENT    // En attente d'expédition vendeur
  IN_TRANSIT_TO_GEARTED // En transit vers Gearted
  RECEIVED_BY_GEARTED  // Reçu par Gearted
  UNDER_VERIFICATION   // En cours de vérification
  VERIFIED             // Vérifié et approuvé
  ISSUE_DETECTED       // Problème détecté
  IN_TRANSIT_TO_BUYER  // En transit vers l'acheteur
  DELIVERED            // Livré à l'acheteur
  COMPLETED            // Service terminé
  CANCELLED            // Annulé
  REFUNDED             // Remboursé
}

// ==========================================
// ADMIN - Platform Settings
// ==========================================
model PlatformSettings {
  id        String   @id @default(cuid())
  key       String   @unique // 'commissions', 'features', etc.
  value     Json     // Flexible JSON storage
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_settings")
}

// ==========================================
// ADMIN - Advertisements
// ==========================================
model Advertisement {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String   // URL de l'image de la publicité
  link        String?  // URL de destination au clic
  placement   String   // 'home', 'landing', 'sidebar', 'banner'
  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime? // Null = pas de fin

  // Statistiques
  impressions Int      @default(0) // Nombre d'affichages
  clicks      Int      @default(0) // Nombre de clics

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("advertisements")
}
