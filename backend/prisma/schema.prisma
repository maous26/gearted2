// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String  @id @default(cuid())
  email     String  @unique
  username  String  @unique
  password  String? // Optional pour OAuth users
  firstName String?
  lastName  String?
  avatar    String?
  phone     String?

  // OAuth fields
  provider     String?   // "local", "discord", etc.
  providerId   String?   // Discord user ID
  providerData Json?     // Données brutes du provider

  // Account status
  isEmailVerified Boolean  @default(false)
  isActive        Boolean  @default(true)
  role            UserRole @default(USER)

  // Profile information
  bio      String?
  location String?
  badges   String[] @default([]) // Discord badges/roles

  // Security
  refreshToken String?

  @@unique([provider, providerId]) // Éviter les doublons OAuth
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products       Product[]
  sentMessages   Message[]
  conversations  Conversation[] @relation("ConversationParticipants")
  stripeAccount  StripeAccount?
  transactions   Transaction[]

  @@map("users")
}

// Product Management
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products Product[]
  
  @@map("categories")
}

// Chat & Messaging
model Conversation {
  id           String    @id @default(cuid())
  participants User[]    @relation("ConversationParticipants")
  messages     Message[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String
  sentAt         DateTime     @default(now())

  @@map("messages")
}

model Brand {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  logo        String?
  isActive    Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products      Product[]
  manufacturers Manufacturer[]
  
  @@map("brands")
}

// Airsoft Weapon Manufacturers/Constructors
model Manufacturer {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  country     String?
  description String?
  logo        String?
  website     String?
  popularity  Int     @default(0) // For ranking top constructors
  isActive    Boolean @default(true)
  
  // Relation to Brand (optional - some manufacturers are also brands)
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  weaponModels WeaponModel[]
  
  @@map("manufacturers")
}

// Weapon Models (specific guns from manufacturers)
model WeaponModel {
  id             String       @id @default(cuid())
  name           String
  manufacturerId String
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])
  
  weaponType WeaponType
  model      String // e.g., "AK-47", "M4A1"
  version    String? // e.g., "V2", "2023"
  
  // Technical specifications
  gearboxType  String? // e.g., "V2", "V3"
  hopUpType    String?
  barrelLength Float? // in mm
  magazineType String?
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  compatibleParts PartCompatibility[]
  
  @@unique([manufacturerId, model, version])
  @@map("weapon_models")
}

// Compatible Parts and Accessories
model Part {
  id           String   @id @default(cuid())
  name         String
  manufacturer String
  partType     PartType
  
  // Specifications
  specifications String? // JSON string for flexible specs
  price          Decimal?
  priceRange     String? // e.g., "$20-$30"
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  compatibility PartCompatibility[]
  
  @@map("parts")
}

// Compatibility Matrix
model PartCompatibility {
  id String @id @default(cuid())
  
  weaponModelId String
  weaponModel   WeaponModel @relation(fields: [weaponModelId], references: [id])
  
  partId String
  part   Part   @relation(fields: [partId], references: [id])
  
  // Compatibility score (0-100)
  compatibilityScore Int @default(100)
  
  // Additional info
  notes                String?
  requiresModification Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([weaponModelId, partId])
  @@map("part_compatibility")
}

model Product {
  id          String @id @default(cuid())
  title       String
  description String
  slug        String @unique
  
  // Basic information
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id])
  
  // Seller information
  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id])
  
  // Product details
  condition ProductCondition
  price     Decimal
  currency  String           @default("EUR")

  // Product status
  status   ProductStatus @default(DRAFT)
  isActive Boolean       @default(true)
  soldAt   DateTime?     // Date when product was marked as sold (payment succeeded)
  deletionScheduledAt DateTime? // Auto-delete 3 days after soldAt

  // Location and shipping
  location         String?
  shippingIncluded Boolean  @default(false)
  shippingCost     Decimal?
  parcelDimensionsId String? // Lien vers les dimensions du colis
  parcelDimensions ParcelDimensions? @relation(fields: [parcelDimensionsId], references: [id])
  
  // Payment tracking
  paymentCompleted Boolean   @default(false) // Paiement réussi
  paymentCompletedAt DateTime? // Date du paiement

  // Analytics
  views Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  images       ProductImage[]
  transactions Transaction[]
  shipments    Shipment[]

  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url       String
  alt       String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)
  
  createdAt DateTime @default(now())
  
  @@map("product_images")
}

model Favorite {
  id           String   @id @default(cuid())
  userId       String
  productId    String
  productTitle String?
  productImage String?
  createdAt    DateTime @default(now())
  
  @@unique([userId, productId])
  @@map("favorites")
}

// Enums
enum UserRole {
  USER
  SELLER
  ADMIN
  MODERATOR
}

enum ProductCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
  FOR_PARTS
}

enum ProductStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  SOLD
  EXPIRED
  SUSPENDED
  DELETED
}

enum WeaponType {
  ASSAULT_RIFLE
  SMG
  SNIPER_RIFLE
  PISTOL
  LMG
  SHOTGUN
  DMR
  CARBINE
}

enum PartType {
  MAGAZINE
  BARREL
  HOP_UP
  GEARBOX
  MOTOR
  BATTERY
  OPTIC
  STOCK
  GRIP
  SUPPRESSOR
  RAIL_SYSTEM
  TRIGGER
  PISTON
  SPRING
  CYLINDER
  NOZZLE
  TAPPET_PLATE
}

// Stripe Connect Models
model StripeAccount {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe Connect account ID
  stripeAccountId String  @unique
  accountType     String  @default("express") // "express" or "standard"

  // Account status
  chargesEnabled  Boolean @default(false)
  payoutsEnabled  Boolean @default(false)
  detailsSubmitted Boolean @default(false)

  // Onboarding
  onboardingComplete Boolean @default(false)

  // Metadata
  country  String?
  currency String  @default("eur")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stripe_accounts")
}

model Transaction {
  id        String @id @default(cuid())

  // Product and buyer
  productId String
  product   Product @relation(fields: [productId], references: [id])
  buyerId   String
  buyer     User    @relation(fields: [buyerId], references: [id])

  // Payment info
  amount           Decimal
  currency         String  @default("EUR")
  platformFee      Decimal // Commission Gearted
  sellerAmount     Decimal // Montant pour le vendeur

  // Stripe IDs
  paymentIntentId  String  @unique
  transferId       String? // Transfer to seller's connected account

  // Status
  status TransactionStatus @default(PENDING)

  // Shipping
  shippingAddress  Json?
  trackingNumber   String?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

// Dimensions du colis (renseignées par le vendeur)
model ParcelDimensions {
  id        String @id @default(cuid())
  
  // Dimensions en cm
  length Float // Longueur
  width  Float // Largeur  
  height Float // Hauteur
  weight Float // Poids en kg
  
  // Optionnel: lien vers catalogue prédéfini
  weaponModelId    String?
  manufacturerId   String?
  name             String? // Ex: "Boîte Tokyo Marui M4"
  isFromCatalog    Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  products  Product[]
  shipments Shipment[]
  
  @@map("parcel_dimensions")
}

// Expéditions
model Shipment {
  id String @id @default(cuid())
  
  // Produit et utilisateurs
  productId String
  product   Product @relation(fields: [productId], references: [id])
  buyerId   String
  sellerId  String
  
  // Numéro de commande
  orderNumber String @unique
  
  // Shippo tracking
  shippoObjectId String?
  trackingNumber String?
  labelUrl       String?
  trackingStatus String? @default("UNKNOWN")
  
  // Adresses
  fromAddress Json // Adresse vendeur
  toAddress   Json // Adresse acheteur
  
  // Dimensions du colis
  parcelId String?
  parcel   ParcelDimensions? @relation(fields: [parcelId], references: [id])
  
  // Transporteur
  carrier           String?
  serviceLevelToken String?
  estimatedDays     Int?
  
  // Montant
  amount   Decimal
  currency String  @default("EUR")
  
  // Statut
  status String @default("PENDING") // PENDING, LABEL_CREATED, SHIPPED, DELIVERED, CANCELLED
  isPaid Boolean @default(false)
  
  // Métadonnées
  metadata Json?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  shippedAt   DateTime?
  deliveredAt DateTime?
  
  @@map("shipments")
}
