// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User Management
model User {
  id        String  @id @default(cuid())
  email     String  @unique
  username  String  @unique
  password  String
  firstName String?
  lastName  String?
  avatar    String?
  phone     String?

  // Account status
  isEmailVerified Boolean  @default(false)
  isActive        Boolean  @default(true)
  role            UserRole @default(USER)

  // Profile information
  bio      String?
  location String?

  // Security
  refreshToken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products      Product[]
  sentMessages  Message[]
  conversations Conversation[] @relation("ConversationParticipants")

  @@map("users")
}

// Product Management
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products Product[]

  @@map("categories")
}

// Chat & Messaging
model Conversation {
  id           String    @id @default(cuid())
  participants User[]    @relation("ConversationParticipants")
  messages     Message[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String
  sentAt         DateTime     @default(now())

  @@map("messages")
}

model Brand {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  logo        String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products      Product[]
  manufacturers Manufacturer[]

  @@map("brands")
}

// Airsoft Weapon Manufacturers/Constructors
model Manufacturer {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  country     String?
  description String?
  logo        String?
  website     String?
  popularity  Int     @default(0) // For ranking top constructors
  isActive    Boolean @default(true)

  // Relation to Brand (optional - some manufacturers are also brands)
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  weaponModels WeaponModel[]

  @@map("manufacturers")
}

// Weapon Models (specific guns from manufacturers)
model WeaponModel {
  id             String       @id @default(cuid())
  name           String
  manufacturerId String
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])

  weaponType WeaponType
  model      String // e.g., "AK-47", "M4A1"
  version    String? // e.g., "V2", "2023"

  // Technical specifications
  gearboxType  String? // e.g., "V2", "V3"
  hopUpType    String?
  barrelLength Float? // in mm
  magazineType String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  compatibleParts PartCompatibility[]

  @@unique([manufacturerId, model, version])
  @@map("weapon_models")
}

// Compatible Parts and Accessories
model Part {
  id           String   @id @default(cuid())
  name         String
  manufacturer String
  partType     PartType

  // Specifications
  specifications String? // JSON string for flexible specs
  price          Decimal?
  priceRange     String? // e.g., "$20-$30"

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  compatibility PartCompatibility[]

  @@map("parts")
}

// Compatibility Matrix
model PartCompatibility {
  id String @id @default(cuid())

  weaponModelId String
  weaponModel   WeaponModel @relation(fields: [weaponModelId], references: [id])

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  // Compatibility score (0-100)
  compatibilityScore Int @default(100)

  // Additional info
  notes                String?
  requiresModification Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([weaponModelId, partId])
  @@map("part_compatibility")
}

model Product {
  id          String @id @default(cuid())
  title       String
  description String
  slug        String @unique

  // Basic information
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id])

  // Seller information
  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id])

  // Product details
  condition ProductCondition
  price     Decimal
  currency  String           @default("EUR")

  // Sale or Trade
  listingType ListingType @default(SALE) // SALE, TRADE, or BOTH
  tradeFor    String? // Description of what the seller wants in exchange

  // Product status
  status   ProductStatus @default(DRAFT)
  isActive Boolean       @default(true)

  // Location and shipping
  location         String?
  shippingIncluded Boolean  @default(false)
  shippingCost     Decimal?

  // Analytics
  views Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  images ProductImage[]

  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String
  alt       String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  @@map("product_images")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("favorites")
}

// Enums
enum UserRole {
  USER
  SELLER
  ADMIN
  MODERATOR
}

enum ProductCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
  FOR_PARTS
}

enum ListingType {
  SALE // Vente uniquement
  TRADE // Échange uniquement
  BOTH // Vente ou échange
}

enum ProductStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  SOLD
  EXPIRED
  SUSPENDED
  DELETED
}

enum WeaponType {
  ASSAULT_RIFLE
  SMG
  SNIPER_RIFLE
  PISTOL
  LMG
  SHOTGUN
  DMR
  CARBINE
}

enum PartType {
  MAGAZINE
  BARREL
  HOP_UP
  GEARBOX
  MOTOR
  BATTERY
  OPTIC
  STOCK
  GRIP
  SUPPRESSOR
  RAIL_SYSTEM
  TRIGGER
  PISTON
  SPRING
  CYLINDER
  NOZZLE
  TAPPET_PLATE
}

// Shipping & Logistics Models
model Shipment {
  id              String         @id @default(cuid())
  
  // Order reference
  productId       String
  buyerId         String
  sellerId        String
  orderNumber     String         @unique // Format: #1000, #1001, etc.
  
  // Shippo tracking
  shippoObjectId  String?        @unique // Shippo transaction ID
  trackingNumber  String?
  labelUrl        String?
  trackingStatus  String?        @default("UNKNOWN")
  
  // Addresses
  fromAddress     String         // JSON string
  toAddress       String         // JSON string
  
  // Parcel details
  parcelId        String?
  parcel          ParcelDimensions? @relation(fields: [parcelId], references: [id])
  
  // Shipping details
  carrier         String?        // e.g., "colissimo", "chronopost"
  serviceLevelToken String?      // Shippo service level token
  estimatedDays   Int?
  
  // Costs
  amount          Decimal
  currency        String         @default("EUR")
  
  // Status
  status          ShipmentStatus @default(PENDING)
  isPaid          Boolean        @default(false)
  
  // Metadata
  metadata        String?        // JSON for extra data
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  @@map("shipments")
}

model ParcelDimensions {
  id              String    @id @default(cuid())
  
  // Reference (optional - from catalog or manual)
  weaponModelId   String?
  manufacturerId  String?
  
  // Dimensions (in cm)
  length          Float
  width           Float
  height          Float
  
  // Weight (in kg)
  weight          Float
  
  // Metadata
  name            String?   // e.g., "AK-47 Standard Box"
  isFromCatalog   Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  shipments       Shipment[]
  
  @@map("parcel_dimensions")
}

model ShippingRate {
  id                String   @id @default(cuid())
  
  // Reference
  shipmentId        String?
  
  // Carrier info
  carrier           String   // e.g., "colissimo"
  carrierName       String   // e.g., "La Poste"
  serviceLevelName  String   // e.g., "Colissimo Domicile"
  serviceLevelToken String   // Shippo service level token
  
  // Pricing
  amount            Decimal
  currency          String   @default("EUR")
  
  // Delivery estimate
  estimatedDays     Int?
  durationTerms     String?  // e.g., "2-3 jours ouvrés"
  
  // Zone
  zone              String?  // "FR", "EU", "WORLD"
  
  // Metadata
  attributes        String?  // JSON for carrier-specific attributes
  
  createdAt         DateTime @default(now())
  expiresAt         DateTime? // Rates expire after some time
  
  @@map("shipping_rates")
}

// Enums for Shipping
enum ShipmentStatus {
  PENDING           // Awaiting payment
  PAID              // Payment received
  LABEL_CREATED     // Label generated
  IN_TRANSIT        // Shipped
  OUT_FOR_DELIVERY  // Out for delivery
  DELIVERED         // Delivered
  FAILED            // Delivery failed
  RETURNED          // Returned to sender
  CANCELLED         // Cancelled
}
